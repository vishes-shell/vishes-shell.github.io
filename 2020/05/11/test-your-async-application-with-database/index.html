<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>Test your async application with database | Yet another blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-166126257-1','auto');ga('send','pageview');
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Test your async application with database</h1><a id="logo" href="/.">Yet another blog</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Test your async application with database</h1><div class="post-meta">2020-05-11</div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">Contents</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Purpose"><span class="toc-number">1.</span> <span class="toc-text">Purpose</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ways-to-keep-db-fresh"><span class="toc-number">2.</span> <span class="toc-text">Ways to keep db fresh</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tools"><span class="toc-number">3.</span> <span class="toc-text">Tools</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Project"><span class="toc-number">4.</span> <span class="toc-text">Project</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tests-setup"><span class="toc-number">5.</span> <span class="toc-text">Tests setup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Implementation"><span class="toc-number">6.</span> <span class="toc-text">Implementation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Test-function"><span class="toc-number">6.1.</span> <span class="toc-text">Test function</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Check-that-database-is-clean-after-test"><span class="toc-number">6.2.</span> <span class="toc-text">Check that database is clean after test</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Rollback-transaction-fixture"><span class="toc-number">6.3.</span> <span class="toc-text">Rollback transaction fixture</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Any-other-ways"><span class="toc-number">6.4.</span> <span class="toc-text">Any other ways?</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">7.</span> <span class="toc-text">Conclusion</span></a></li></ol></div></div><div class="post-content"><p>With rise of python <em>async</em> support (thanks to <a href="https://docs.python.org/3/library/asyncio.html" target="_blank" rel="noopener"><code>asyncio</code></a>
library) new async frameworks/libraries/clients started to pop out and grow in popularity. More and more people want to try <em>async</em> features and enter this
magical world where everything does something useful while waiting for <em>IO guys</em>.</p>
<p>So you are one of those who want to do more than making
<a href="https://docs.python.org/3/library/asyncio-task.html#asyncio.sleep" target="_blank" rel="noopener"><code>asyncio.sleep(n)</code></a>
and be proud of how cool it is to be on the edge of technology. Putting your
program to sleep is easy, but you are not stopping there, you want to solve more real world scenarios: HTTP requests,
databases, etc. Also you want to test them.
That’s what this article is about - <em>finding a way to test your async application
that has some connections to database</em>.</p>
<h2 id="Purpose"><a href="#Purpose" class="headerlink" title="Purpose"></a>Purpose</h2><p>Here is a list of testing rules (one of many): <a href="https://docs.python-guide.org/writing/tests/" target="_blank" rel="noopener">Testing Your Code</a></p>
<p>The part that we want to discuss is this:</p>
<blockquote>
<p>Each test unit must be fully independent. Each test must be able to run alone,
and also within the test suite, regardless of the order that they are called.
The implication of this rule is that each test must be loaded with a fresh
dataset and may have to do some cleanup afterwards.</p>
</blockquote>
<p>Summary: we want to work with database in tests, also we have some requirements:</p>
<ul>
<li>database must be isolated</li>
<li>it is necessary to clean everything after each test run</li>
</ul>
<h2 id="Ways-to-keep-db-fresh"><a href="#Ways-to-keep-db-fresh" class="headerlink" title="Ways to keep db fresh"></a>Ways to keep db fresh</h2><ol>
<li><p>Run everything in transaction and then roll them back (e.g.
<a href="https://docs.djangoproject.com/en/dev/topics/testing/overview/#testcase" target="_blank" rel="noopener"><code>django</code> test ecosystem</a>
does so)</p>
<p><em>Thoughts</em>: Would be perfect</p>
</li>
<li><p>Drop database after every test (this will keep database clean for sure)</p>
<p><em>Thoughts</em>: Not really good (too heavy operation)</p>
</li>
<li><p>Delete data in all tables</p>
<p><em>Thoughts</em>: Fast but what would you do if there are a lot of tables?</p>
</li>
<li><p>Truncate data in all tables</p>
<p><em>Thoughts</em>: Faster than deleting, however you still need to go through all
tables and <code>sqlalchemy</code> has no method for that, but who cares?</p>
</li>
<li><p>Unapply and then reapply migrations (if you have them, maybe
<a href="https://alembic.sqlalchemy.org/en/latest/" target="_blank" rel="noopener"><code>alembic</code></a>)</p>
<p><em>Thoughts</em>: Same as dropping database, not so good</p>
</li>
</ol>
<p>The best way is to put tests in transactions and roll them back after test finishes.</p>
<h2 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h2><p>For <em>testing</em> purposes we will use awesome
<a href="https://docs.pytest.org/en/latest/" target="_blank" rel="noopener"><code>pytest</code></a>. I won’t dive in to how good
<code>pytest</code> is, there is official documentation, lots of articles, conference talks
and stackoverflow questions. But if you are still loyal to <code>unittest</code> i’m not
quite sure this article is for you.</p>
<p>Async <em>database client</em> will be
<a href="https://github.com/encode/databases" target="_blank" rel="noopener"><code>databases</code></a>, because it’s ready to use
and <a href="http://www.tomchristie.com/" target="_blank" rel="noopener">Tom Christie</a>
(<a href="https://github.com/encode/databases/commit/388f163096c9f4e274b57523b18b6c59ff33b306" target="_blank" rel="noopener">creator</a>)
knows the way to build beautiful software.</p>
<p>For <code>databases</code> it will be <code>sqlite</code> since it’s so easy to use - you can just
copy and paste lines (<em>isn’t this our most loved one??</em>).</p>
<h2 id="Project"><a href="#Project" class="headerlink" title="Project"></a>Project</h2><p>For testing purposes Note model will be used:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  app/models.py</span></span><br><span class="line"><span class="keyword">import</span> sqlalchemy <span class="keyword">as</span> sa</span><br><span class="line"></span><br><span class="line">metadata = sa.MetaData()</span><br><span class="line"></span><br><span class="line">notes = sa.Table(</span><br><span class="line">    <span class="string">"notes"</span>,</span><br><span class="line">    metadata,</span><br><span class="line">    sa.Column(<span class="string">"id"</span>, sa.Integer, primary_key=<span class="literal">True</span>),</span><br><span class="line">    sa.Column(<span class="string">"text"</span>, sa.String),</span><br><span class="line">    sa.Column(<span class="string">"completed"</span>, sa.Boolean),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="Tests-setup"><a href="#Tests-setup" class="headerlink" title="Tests setup"></a>Tests setup</h2><p>We create <em>session</em> scope fixture that creates our database with defined tables
and deletes them when test run will be completed:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  tests/conftest.py</span></span><br><span class="line"><span class="keyword">import</span> pytest</span><br><span class="line"><span class="keyword">import</span> sqlalchemy <span class="keyword">as</span> sa</span><br><span class="line"><span class="keyword">from</span> app.models <span class="keyword">import</span> metadata</span><br><span class="line"><span class="keyword">from</span> databases <span class="keyword">import</span> Database</span><br><span class="line"></span><br><span class="line">SQLITE_DATABASE_URL = <span class="string">"sqlite:///./test.db"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@pytest.fixture(scope="session")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sqlite_db</span><span class="params">()</span> -&gt; Database:</span></span><br><span class="line">    engine = sa.create_engine(SQLITE_DATABASE_URL)</span><br><span class="line">    metadata.create_all(engine)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">yield</span> Database(SQLITE_DATABASE_URL)</span><br><span class="line"></span><br><span class="line">    metadata.drop_all(engine)</span><br></pre></td></tr></table></figure>

<h2 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h2><p>Note: <em>For running async tests (they should be async since you are dealing with
async code) you would require
<a href="https://github.com/pytest-dev/pytest-asyncio" target="_blank" rel="noopener"><code>pytest-asyncio</code></a> and decorate
your test with <code>@pytest.mark.asyncio</code> or apply asyncio mark to all tests like that:</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pytestmark = pytest.mark.asyncio</span><br></pre></td></tr></table></figure>

<p>Another way to test async is to create your own decorator as in <code>databases</code>:
<a href="https://github.com/encode/databases/blob/master/tests/test_databases.py#L100-L111" target="_blank" rel="noopener"><code>async_adapter</code></a>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">async_adapter</span><span class="params">(wrapped_func)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Decorator used to run async test cases.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @functools.wraps(wrapped_func)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run_sync</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        loop = asyncio.new_event_loop()</span><br><span class="line">        task = wrapped_func(*args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> loop.run_until_complete(task)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> run_sync</span><br></pre></td></tr></table></figure>

<h3 id="Test-function"><a href="#Test-function" class="headerlink" title="Test function"></a>Test function</h3><p>Define generic function that inserts data and check if it’s there.
We use <code>pytest.fail</code> since we want this function to be used by every
test.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(sqlite_db)</span>:</span></span><br><span class="line">    <span class="string">"""Insert data and check that it exist in database</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    query = notes.insert().values(text=<span class="string">"text"</span>, completed=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">await</span> sqlite_db.execute(query)</span><br><span class="line"></span><br><span class="line">    query = notes.select()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">await</span> sqlite_db.fetch_all(query):</span><br><span class="line">        pytest.fail(<span class="string">"no data in database"</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Check-that-database-is-clean-after-test"><a href="#Check-that-database-is-clean-after-test" class="headerlink" title="Check that database is clean after test"></a>Check that database is clean after test</h3><p>We can achieve that with fixture which runs after test completion:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@pytest.fixture</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">check_empty_database</span><span class="params">(sqlite_db)</span>:</span></span><br><span class="line">    <span class="string">"""All tests use transaction and database clean after tests</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">yield</span></span><br><span class="line"></span><br><span class="line">    query = notes.select()</span><br><span class="line">    data = <span class="keyword">await</span> sqlite_db.fetch_all(query)</span><br><span class="line">    <span class="keyword">if</span> data:</span><br><span class="line">        pytest.fail(<span class="string">"db data should be rolled back"</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Rollback-transaction-fixture"><a href="#Rollback-transaction-fixture" class="headerlink" title="Rollback transaction fixture"></a>Rollback transaction fixture</h3><p>The most obvious way is to implement transactional fixture with force rollback
transaction context manager as this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@pytest.fixture</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">rollback_transaction</span><span class="params">(sqlite_db)</span>:</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> sqlite_db.transaction(force_rollback=<span class="literal">True</span>):</span><br><span class="line">        <span class="keyword">yield</span></span><br></pre></td></tr></table></figure>

<p>And to test this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@pytest.mark.asyncio</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">test_rollback_transaction_fixture_and_asyncio_mark</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    sqlite_db, rollback_transaction, check_empty_database</span></span></span><br><span class="line"><span class="function"><span class="params">)</span>:</span></span><br><span class="line">    <span class="keyword">await</span> main(sqlite_db)</span><br></pre></td></tr></table></figure>

<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> pytest -k test_rollback_transaction_fixture_and_asyncio_mark</span></span><br><span class="line">tests/test_databases_sqlite.py .E                               [100%]</span><br><span class="line"></span><br><span class="line">=========================== ERRORS ===================================</span><br><span class="line">__ ERROR at teardown of test_rollback_transaction_fixture_and_asyncio_mark __</span><br><span class="line"></span><br><span class="line">sqlite_db = &lt;databases.core.Database object at 0x10736d640&gt;</span><br><span class="line"></span><br><span class="line">    @pytest.fixture</span><br><span class="line">    async def check_empty_database(sqlite_db):</span><br><span class="line">        """All tests use transaction and database clean after tests</span><br><span class="line">        """</span><br><span class="line">        yield</span><br><span class="line"></span><br><span class="line">        query = notes.select()</span><br><span class="line">        data = await sqlite_db.fetch_all(query)</span><br><span class="line">        if data:</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">           pytest.fail(<span class="string">"db data should be rolled back"</span>)</span></span><br><span class="line">E           Failed: db data should be rolled back</span><br><span class="line"></span><br><span class="line">tests/test_databases_sqlite.py:16: Failed</span><br><span class="line">======================= short test summary info ======================</span><br><span class="line">ERROR tests/test_databases_sqlite.py::test_rollback_transaction_fixture_and_asyncio_mark - Failed: db data should be rolled back</span><br></pre></td></tr></table></figure>

<p>We can see that the test is passed, but due to <code>pytest</code> fixtures implementation
we cannot make them to fail test, only to create an error. But in this case it’s
clear that <em>data was not cleaned</em>.</p>
<p>But why? Maybe <code>force_rollback</code> transaction don’t even work? We can try
and make sure that it’s not our fault:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@pytest.mark.asyncio</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">test_base_context_manager</span><span class="params">(sqlite_db, check_empty_database)</span>:</span></span><br><span class="line">    <span class="string">"""Transaction context manager with force_rollback</span></span><br><span class="line"><span class="string">    rolls transaction after all</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> sqlite_db.transaction(force_rollback=<span class="literal">True</span>):</span><br><span class="line">        <span class="keyword">await</span> main(sqlite_db)</span><br></pre></td></tr></table></figure>

<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> pytest -k test_base_context_manager</span></span><br><span class="line">======================= test session starts ==========================</span><br><span class="line">platform darwin -- Python 3.8.2, pytest-5.4.2, py-1.8.1, pluggy-0.13.1</span><br><span class="line">rootdir: /Users/vishes/Personal/github/pytest-asyncio-db-transactions</span><br><span class="line">plugins: asyncio-0.12.0</span><br><span class="line">collected 5 items / 4 deselected / 1 selected</span><br><span class="line">tests/test_databases_sqlite.py .                                [100%]</span><br></pre></td></tr></table></figure>

<p>Force rollback transaction works as expected, but why transaction is not rolled
back in fixture? The reason is that async fixtures are executed in their own
context. So maybe transaction was rolled back, however not the one we
wanted to.</p>
<h3 id="Any-other-ways"><a href="#Any-other-ways" class="headerlink" title="Any other ways?"></a>Any other ways?</h3><p>Writing context manager in each test is not
<a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself" target="_blank" rel="noopener">DRY</a> at all, yet it
will get us where we want. But there is another way: <em>decorator</em>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">transaction_wrapper</span><span class="params">(func, rollback=True)</span>:</span></span><br><span class="line"><span class="meta">    @functools.wraps(func)</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(sqlite_db, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> sqlite_db.transaction(force_rollback=rollback):</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> func(sqlite_db, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br></pre></td></tr></table></figure>

<p>All we need to do is to decorate our test method:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@transaction_wrapper</span></span><br><span class="line"><span class="meta">@pytest.mark.asyncio</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">test_transaction_wrapper</span><span class="params">(sqlite_db, check_empty_database)</span>:</span></span><br><span class="line">    <span class="string">"""Transaction wrapper with default rolling back</span></span><br><span class="line"><span class="string">    rolls transaction after tests completes with pytest asyncio mark</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">await</span> main(sqlite_db)</span><br></pre></td></tr></table></figure>

<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> pytest -k test_transaction_wrapper_and_async_adapter</span></span><br><span class="line">======================== test session starts =========================</span><br><span class="line">platform darwin -- Python 3.8.2, pytest-5.4.2, py-1.8.1, pluggy-0.13.1</span><br><span class="line">rootdir: /Users/vishes/Personal/github/pytest-asyncio-db-transactions</span><br><span class="line">plugins: asyncio-0.12.0</span><br><span class="line">collected 5 items / 4 deselected / 1 selected</span><br><span class="line"></span><br><span class="line">tests/test_databases_sqlite.py .                                [100%]</span><br></pre></td></tr></table></figure>

<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>We couldn’t make database test setup with <em>pytest fixture</em> (maybe even
with <code>autouse=True</code>), however <strong>we’ve achieved tests with rolled back
transactions through decorator</strong>, which is quite good.</p>
<p>I hope someday we all can use async fixtures, but by now <em>decoration</em> is one
of the cleanest methods.</p>
<p>Source code can be found here:
<a href="https://github.com/vishes-shell/pytest-asyncio-db-transactions" target="_blank" rel="noopener">vishes-shell/pytest-asyncio-db-transactions</a></p>
</div><div class="tags"><a href="/tags/async/"><i class="fa fa-tag"></i>async</a><a href="/tags/tests/"><i class="fa fa-tag"></i>tests</a><a href="/tags/databases/"><i class="fa fa-tag"></i>databases</a><a href="/tags/python/"><i class="fa fa-tag"></i>python</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://vishes-shell.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/async/" style="font-size: 15px;">async</a> <a href="/tags/tests/" style="font-size: 15px;">tests</a> <a href="/tags/databases/" style="font-size: 15px;">databases</a> <a href="/tags/python/" style="font-size: 15px;">python</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/05/11/test-your-async-application-with-database/">Test your async application with database</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">Yet another blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>